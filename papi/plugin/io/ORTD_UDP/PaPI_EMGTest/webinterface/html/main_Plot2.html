<html>
<head>



    <div id="Plot"></div>

    <script src = "/socket.io/socket.io.js" > </script>
    <script type=text/javascript src="/lib/jquery-1.7.1.min.js"></script>
    <script type=text/javascript src="/lib/kinetic-v5.0.1.min.js"></script>
    <script type=text/javascript src="/lib/ORTD.js"></script>

    <script defer="defer">
/*
   Create plot
*/




/*
   User defined code
*/


  var Plot, PlotMWaveSid, PlotMWaveModelSid;

  function initSelfDefined(ProtocollConfig) {

    // get the source for the measured MWaves
    SP = GetSourceProperties(ProtocollConfig, 'MwaveAndStim1');
    Plot_Nx = SP.veclen;    PlotMWaveSid = SP.PlotSid;

   try {
    // get the source for the matched references
    SP = GetSourceProperties(ProtocollConfig, 'MWaveModel1');
    Plot_Nx = SP.veclen;    PlotMWaveModelSid = SP.PlotSid;
   } catch (e) {
     console.log('Signal source MWaveModel1 could not be found!');
     PlotMWaveModelSid  = -1;
   }



    console.log(PlotMWaveSid); console.log('Plot_Nx' + Plot_Nx);

    //Plot = new VectorPlotClass('Plot', 300, 700,  Plot_Nx);
    Plot = new VectorPlotClass3('Plot', 300, 700,  Plot_Nx, 5);
  }

  function DataAvailableSelfDefined(SourceID, Values) {
            // 
            if (SourceID == PlotMWaveSid) {
              scale = 0.1; ofs =  0;
              Plot.PlotDraw(Values, ofs, scale);
            } else if (SourceID == PlotMWaveModelSid) {
              scale = 0.1; ofs =  0;
              Plot.PlotDrawRedLine(Values, ofs, scale);
            }

   }




  // if ==1 then the automatically created displays are updated
  var UpdateAutoDisplays = 0;


/*
   End of user defined code
*/








        var ProtocollConfig;
        var socket = io.connect();
 
	// console.log(  GetParameterID(ProtocollConfig.ParametersConfig, "Parameter2") );


        socket.on('ProtocollConfig', function (ProtocollConfig__) { 
          // received the protocoll definition
          ProtocollConfig = ProtocollConfig__;
          
          // Set-up the Displays for all Sources
          var htmlcode;

          // Creates a Display for each source
          SourcesConfig = ProtocollConfig.SourcesConfig;
          for (key in SourcesConfig) {
            try {
              htmlcode = htmlcode  + '<br><br><strong>Source Name</strong> ' + SourcesConfig[key].SourceName + '<br>';
              htmlcode = htmlcode  + '<strong>Data:</strong> <div id="Display' + key  + '">--</div>'
            } catch (err) { ; }
            
            htmlcode = htmlcode + ' <br><br> ';
          }
          
          document.getElementById('Displays').innerHTML = htmlcode;

          
          // Creates a ... for each parameter
          ParametersConfig = ProtocollConfig.ParametersConfig;
          htmlcode = '';
          for (key in ParametersConfig) {
            try {
              ParameterName = ParametersConfig[key].ParameterName;
              
              htmlcode = htmlcode  + '<br><br><strong>Parameter Name</strong> ' + ParameterName + '<br>';
              htmlcode = htmlcode  + '<strong>Elements:</strong><br> '
              
              var i;
              for (i=0; i< ParametersConfig[key].NValues; ++i) {
               // htmlcode = htmlcode  + 'e' + i + '<br>';
                htmlcode = htmlcode + '<input id="' + ParameterName + '_' + i + '" type="text" size="20" maxlength="20" value="0.00"><br>';

              }
              
            } catch (err) { ; }
            
            htmlcode = htmlcode + '<input type="button" id="UploadParameters" value="Upload Parameters" onClick="UploadParameters('+key+');">';            
            htmlcode = htmlcode + ' <br><br> ';

            console.log(htmlcode);
          }
          
//           htmlcode = JSON.stringify(ParametersConfig  );
          
          document.getElementById('Parameters').innerHTML = htmlcode;          
          
          // display the protocoll definition
          htmlcode = JSON.stringify( ProtocollConfig );
          document.getElementById('ProtocollConfiguration').innerHTML = htmlcode;

          // Call user definable function
          initSelfDefined(ProtocollConfig);
        });
        
	// wait for new signal-samples
	socket.on('Update', function (data) {
	    //console.log(data);
	    
	    // get configuration
	    NValues = ProtocollConfig.SourcesConfig[data.SourceID].NValues_send;	     
	    Values = data.Data;
	    
            DataAvailableSelfDefined(data.SourceID, Values);

            if (UpdateAutoDisplays == 1) {
	      // Update the display for this source. Compose html code for the Display to print the data
	      var htmlcode, i;
	      htmlcode = '#'+NValues+'<br>';
	      for (i=0; i<NValues; ++i) {
		htmlcode = htmlcode + i + ' = '+Values[i]+'<br>';	      
	      }
	      
	      document.getElementById('Display'+data.SourceID).innerHTML = htmlcode;
            }
	});


    function UploadParameters(ParameterID){
      // update parameters button was clicked; send parameters
      
      console.log(ParameterID);
      
      ParametersConfig = ProtocollConfig.ParametersConfig;
      ParameterName = ParametersConfig[ParameterID].ParameterName;
      
      ParSet = new Array();
      
              var i;
              for (i=0; i< ParametersConfig[ParameterID].NValues; ++i) {
               // htmlcode = htmlcode  + 'e' + i + '<br>';
                htmlid = ParameterName + '_' + i;
                var p1 = document.getElementById(htmlid).value;
                var p1_float = parseFloat(p1.replace(",", ".")); ParSet[i] = p1_float;

              }
      
//       var p1 = document.getElementById('Parameter1').value;
//       var p1_float = parseFloat(p1.replace(",", ".")); ParSet[0] = p1_float;


      socket.emit('ChangeParam_Set', [ParameterID, ParSet] );
    }






    </script>
</head> 
 
<body>
    <strong>GUI-interface to ORTD-simulation</strong>

  <br><br>

  
  <strong>Parameters:</strong> <div id="Parameters">0</div>
  
  <strong>Displays:</strong> <div id="Displays">0</div>


  <strong>ProtocollConfiguration:</strong> <div id="ProtocollConfiguration">0</div>
  <br><br>


</body>
</html>